## -*- mode: makefile -*-

##
## This file is part of the Score-P software (http://www.score-p.org)
##
## Copyright (c) 2009-2013,
## RWTH Aachen University, Germany
##
## Copyright (c) 2009-2013,
## Gesellschaft fuer numerische Simulation mbH Braunschweig, Germany
##
## Copyright (c) 2009-2013,
## Technische Universitaet Dresden, Germany
##
## Copyright (c) 2009-2013,
## University of Oregon, Eugene, USA
##
## Copyright (c) 2009-2013,
## Forschungszentrum Juelich GmbH, Germany
##
## Copyright (c) 2009-2014,
## German Research School for Simulation Sciences GmbH, Juelich/Aachen, Germany
##
## Copyright (c) 2009-2013,
## Technische Universitaet Muenchen, Germany
##
## This software may be modified and distributed under the terms of
## a BSD-style license.  See the COPYING file in the package base
## directory for details.
##

## Serial

check_PROGRAMS                       += jacobi_serial_c_metric_test
jacobi_serial_c_metric_test_SOURCES   = $(SRC_ROOT)test/services/metric/data/jacobi/serial/C/jacobi.c  \
                                        $(SRC_ROOT)test/services/metric/data/jacobi/serial/C/jacobi.h  \
                                        $(SRC_ROOT)test/services/metric/data/jacobi/serial/C/main.c
jacobi_serial_c_metric_test_CPPFLAGS  = $(AM_CPPFLAGS) @SCOREP_COMPILER_INSTRUMENTATION_CPPFLAGS@

# TODO: -finstrument-functions-exclude-file-list is a quick fix for the problem of recorded enter/leave events of
# printf statements, REMOVE this flag after this bug is fixed properly
if SCOREP_COMPILER_GNU
jacobi_serial_c_metric_test_CPPFLAGS += -finstrument-functions-exclude-file-list=/usr/include
endif

jacobi_serial_c_metric_test_LDADD     = $(serial_libadd)


EXTRA_DIST   += $(SRC_ROOT)test/services/metric/run_rusage_serial_metric_test.sh.in \
                $(SRC_ROOT)test/services/metric/data/jacobi_c_serial_rusage_metric_definitions.out \
                $(SRC_ROOT)test/services/metric/data/jacobi_c_serial_rusage_metric_events.out
EXTRA_DIST   += $(SRC_ROOT)test/services/metric/run_papi_serial_metric_test.sh.in \
                $(SRC_ROOT)test/services/metric/data/jacobi_c_serial_papi_metric_definitions.out \
                $(SRC_ROOT)test/services/metric/data/jacobi_c_serial_papi_metric_events.out

if !SCOREP_COMPILER_SUN
if HAVE_GETRUSAGE
TESTS_SERIAL += ./../test/services/metric/run_rusage_serial_metric_test.sh
endif

if HAVE_PAPI
TESTS_SERIAL += ./../test/services/metric/run_papi_serial_metric_test.sh
endif
jacobi_serial_c_metric_test_LDFLAGS   = $(serial_ldflags) @SCOREP_COMPILER_INSTRUMENTATION_LDFLAGS@
endif

## OpenMP

if HAVE_OPENMP_SUPPORT

# the pomp.c file needs to be compiled without compiler instrumentation
# to achieve this, we put it in a noinst library and link against it
noinst_LTLIBRARIES                      += libjacobi_pomp_c_metric_test.la
libjacobi_pomp_c_metric_test_la_SOURCES  = $(SRC_ROOT)test/services/metric/data/jacobi/OpenMP/C/pomp.c
libjacobi_pomp_c_metric_test_la_CPPFLAGS = $(AM_CPPFLAGS) -I$(INC_ROOT)src

if HAVE_SCOREP_OMP_TPD

check_PROGRAMS                   += jacobi_omp_c_metric_test
jacobi_omp_c_metric_test_SOURCES  = $(SRC_ROOT)test/services/metric/data/jacobi/OpenMP/C/jacobi.mod.c       \
                                    $(SRC_ROOT)test/services/metric/data/jacobi/OpenMP/C/jacobi.c.opari.inc \
                                    $(SRC_ROOT)test/services/metric/data/jacobi/OpenMP/C/jacobi.h           \
                                    $(SRC_ROOT)test/services/metric/data/jacobi/OpenMP/C/main.mod.c         \
                                    $(SRC_ROOT)test/services/metric/data/jacobi/OpenMP/C/main.c.opari.inc
jacobi_omp_c_metric_test_CFLAGS   = $(AM_CFLAGS) $(OPENMP_CFLAGS)
jacobi_omp_c_metric_test_CPPFLAGS = $(AM_CPPFLAGS) @OPARI2_CPPFLAGS@ @SCOREP_COMPILER_INSTRUMENTATION_CPPFLAGS@

# TODO: -finstrument-functions-exclude-file-list is a quick fix for the problem of recorded enter/leave events of
# printf statements, REMOVE this flag after this bug is fixed properly
if SCOREP_COMPILER_GNU
jacobi_omp_c_metric_test_CPPFLAGS += -finstrument-functions-exclude-file-list=/usr/include
endif

# for some unknown reason we need an extra -I for the SUN compiler in
# OpenMP and hybrid mode.
if SCOREP_COMPILER_SUN
jacobi_omp_c_metric_test_CPPFLAGS += -I$(INC_ROOT)test/jacobi/OpenMP/C
endif

jacobi_omp_c_metric_test_LDADD    = $(omp_libadd) libjacobi_pomp_c_metric_test.la

EXTRA_DIST += $(SRC_ROOT)test/services/metric/run_rusage_openmp_metric_test.sh.in \
              $(SRC_ROOT)test/services/metric/data/jacobi_c_openmp_rusage_metric_definitions.out \
              $(SRC_ROOT)test/services/metric/data/jacobi_c_openmp_rusage_metric_events.out \
              $(SRC_ROOT)test/services/metric/run_rusage_openmp_per_process_metric_test.sh.in \
              $(SRC_ROOT)test/services/metric/data/jacobi_c_openmp_rusage_per_process_metric_definitions.out \
              $(SRC_ROOT)test/services/metric/data/jacobi_c_openmp_rusage_per_process_metric_events_1.out \
              $(SRC_ROOT)test/services/metric/data/jacobi_c_openmp_rusage_per_process_metric_events_2.out
EXTRA_DIST += $(SRC_ROOT)test/services/metric/run_papi_openmp_metric_test.sh.in \
              $(SRC_ROOT)test/services/metric/data/jacobi_c_openmp_papi_metric_definitions.out \
              $(SRC_ROOT)test/services/metric/data/jacobi_c_openmp_papi_metric_events.out \
              $(SRC_ROOT)test/services/metric/run_papi_openmp_per_process_metric_test.sh.in \
              $(SRC_ROOT)test/services/metric/data/jacobi_c_openmp_papi_per_process_metric_definitions.out \
              $(SRC_ROOT)test/services/metric/data/jacobi_c_openmp_papi_per_process_metric_events_1.out \
              $(SRC_ROOT)test/services/metric/data/jacobi_c_openmp_papi_per_process_metric_events_2.out

if !SCOREP_COMPILER_SUN
if HAVE_GETRUSAGE
TESTS_OMP  += ./../test/services/metric/run_rusage_openmp_metric_test.sh \
              ./../test/services/metric/run_rusage_openmp_per_process_metric_test.sh
endif

if HAVE_PAPI
TESTS_OMP  += ./../test/services/metric/run_papi_openmp_metric_test.sh \
              ./../test/services/metric/run_papi_openmp_per_process_metric_test.sh
endif

jacobi_omp_c_metric_test_LDFLAGS  = $(omp_ldflags) @SCOREP_COMPILER_INSTRUMENTATION_LDFLAGS@

endif !SCOREP_COMPILER_SUN

endif HAVE_SCOREP_OMP_TPD

endif HAVE_OPENMP_SUPPORT
