#!/bin/sh
## Make ignores the next lines, but shell not -*- mode: makefile -*- \
 argv0=$0; \
 exec make -f "$argv0" "$@"

AUTORECONF      = autoreconf
AUTORECONFFLAGS = -Wall --no-recursive

LOCAL_CONFIGURES = \
	configure \
	build-backend/configure \
	build-frontend/configure \
	build-mpi/configure \
	build-score/configure

SUB_CONFIGURES = \
	vendor/opari2/configure \
	vendor/otf2/configure

.PHONY: all local $(LOCAL_CONFIGURES) $(SUB_CONFIGURES) clean clean-local
all: local $(SUB_CONFIGURES)
local: $(LOCAL_CONFIGURES)
$(LOCAL_CONFIGURES): clean-local

vendor/opari2/configure:
	@$(MAKE) -C vendor/opari2 -f bootstrap AUTORECONF=$(AUTORECONF)

vendor/otf2/configure:
	@$(MAKE) -C vendor/otf2 -f bootstrap AUTORECONF=$(AUTORECONF)

configure:
	$(AUTORECONF) --install $(AUTORECONFFLAGS) .

# automake needs src/config-backend-for-frontend.h.in, but this is generated,
# out of the src/config-backend.h.in which itself is generated by autoheader
# to break this circle, touch an emtpy file
build-backend/configure: configure
	@: >src/config-backend-for-frontend.h.in
	$(AUTORECONF) --install $(AUTORECONFFLAGS) build-backend
	@echo "scorep-autoheader: \`src/config-backend-for-frontend.h.in' is created"; \
            vendor/common/build-config/generate-config-backend-for-frontend.sh \
                src/config-backend.h.in \
                >src/config-backend-for-frontend.h.in

build-frontend/configure: build-backend/configure
	$(AUTORECONF) $(AUTORECONFFLAGS) build-frontend

build-mpi/configure: build-backend/configure
	$(AUTORECONF) $(AUTORECONFFLAGS) build-mpi

build-score/configure: build-backend/configure
	$(AUTORECONF) $(AUTORECONFFLAGS) build-score

clean: clean-local
	@$(MAKE) -C vendor/opari2 -f bootstrap clean
	@$(MAKE) -C vendor/otf2   -f bootstrap clean

clean-local:
	@rm -rf autom4te.cache/ configure aclocal.m4 Makefile.in
	@cd build-config; rm -f compile config.sub install-sh config.guess depcomp ltmain.sh missing
	@cd vendor/common/build-config/m4; rm -f libtool.m4 ltsugar.m4 lt~obsolete.m4 ltoptions.m4 ltversion.m4
	@cd build-backend;  rm -rf autom4te.cache/ configure aclocal.m4 Makefile.in Makefile confdefs.h config.log config.status libtool
	@cd build-mpi;      rm -rf autom4te.cache/ configure aclocal.m4 Makefile.in Makefile confdefs.h config.log config.status libtool
	@cd build-frontend; rm -rf autom4te.cache/ configure aclocal.m4 Makefile.in Makefile confdefs.h config.log config.status libtool
	@cd build-score;    rm -rf autom4te.cache/ configure aclocal.m4 Makefile.in Makefile confdefs.h config.log config.status libtool
	@rm -f build-config/REVISION build-config/REVISION_COMMON
	@rm -f src/config-backend.h.in src/config-backend-mpi.h.in src/config-frontend.h.in src/config-backend-for-frontend.h.in src/config-score.h.in
