#!/bin/sh
## Make ignores the next lines, but shell not -*- mode: makefile -*- \
 argv0=$0; \
 exec make -f "$argv0" "$@"

AUTORECONF      = autoreconf
AUTORECONFFLAGS = -Wall --no-recursive

LOCAL_CONFIGURES = \
	configure \
	build-backend/configure \
	build-frontend/configure \
	build-mpi/configure \
	build-shmem/configure \
	build-score/configure

SUB_CONFIGURES = \
	vendor/opari2/configure \
	vendor/otf2/configure

.PHONY: all local $(LOCAL_CONFIGURES) $(SUB_CONFIGURES) clean clean-local
all: local $(SUB_CONFIGURES)
local: $(LOCAL_CONFIGURES)
$(LOCAL_CONFIGURES): clean-local

vendor/opari2/configure:
	@$(MAKE) -C vendor/opari2 -f bootstrap AUTORECONF=$(AUTORECONF)

vendor/otf2/configure:
	@$(MAKE) -C vendor/otf2 -f bootstrap AUTORECONF=$(AUTORECONF)

configure:
	$(AUTORECONF) --install $(AUTORECONFFLAGS) .

# automake needs src/config-backend-for-frontend.h.in, but this is generated,
# out of the src/config-backend.h.in which itself is generated by autoheader
# to break this circle, touch an emtpy file
build-backend/configure: configure
	@: >src/config-backend-for-frontend.h.in
	cd build-backend; $(AUTORECONF) --install $(AUTORECONFFLAGS)
	@echo "scorep-autoheader: \`src/config-backend-for-frontend.h.in' is created"; \
            vendor/common/build-config/generate-config-backend-for-frontend.sh \
                src/config-backend.h.in \
                >src/config-backend-for-frontend.h.in

build-frontend/configure: build-backend/configure
	cd build-frontend; $(AUTORECONF) $(AUTORECONFFLAGS)

build-mpi/configure: build-backend/configure
	cd build-mpi; $(AUTORECONF) $(AUTORECONFFLAGS)

build-shmem/configure: build-backend/configure
	cd build-shmem; $(AUTORECONF) $(AUTORECONFFLAGS)

build-score/configure: build-backend/configure
	cd build-score; $(AUTORECONF) $(AUTORECONFFLAGS)

clean: clean-local
	@$(MAKE) -C vendor/opari2 -f bootstrap clean
	@$(MAKE) -C vendor/otf2   -f bootstrap clean

clean_files = \
	autom4te.cache/ \
	configure \
	aclocal.m4 \
	Makefile.in \
	Makefile \
	user_provided_configure_args \
	confdefs.h \
	config.log \
	config.status \
	config.summary \
	scorep.summary \
	libtool \
	.deps/ \
	.libs/

sub_builds = \
	backend \
	mpi \
	shmem \
	frontend \
	score

config_headers = \
	backend \
	backend-mpi \
	backend-shmem \
	frontend \
	backend-for-frontend \
	score

clean-local:
	@rm -rf $(clean_files)
	@cd build-config; rm -f compile config.sub install-sh config.guess depcomp ltmain.sh missing ylwrap
	@cd vendor/common/build-config/m4; rm -f libtool.m4 ltsugar.m4 lt~obsolete.m4 ltoptions.m4 ltversion.m4
	@for build in $(sub_builds); do \
	    ( cd build-$$build; rm -rf $(clean_files); ); \
	done
	@rm -f build-config/REVISION build-config/REVISION_COMMON
	@for header in $(config_headers); do \
	    rm -f src/config-$$header.h.in src/config-$$header.h; \
	done
	@rm -f src/config-common.h
